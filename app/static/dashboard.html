<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solvia Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <!-- Side Menu Container -->
    <div id="sidemenu-container"></div>

    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="header">
            <h1 class="greeting">
                Hey, <span class="user-name">Nadra</span>! We're tracking 
                <span class="domain">thenadraagency.com</span>
            </h1>
        </div>

        <!-- Overview Section -->
        <div class="overview-section">
            <h2 class="overview-title">Overview</h2>
            
            <!-- Metrics Cards -->
            <div class="metrics-grid">
                <!-- SEO Score Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">SEO Score</h3>
                        <div class="metric-icon seo-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <rect x="4" y="8" width="3" height="8" fill="#FF6B35"/>
                                <rect x="9" y="6" width="3" height="10" fill="#FF6B35"/>
                                <rect x="14" y="4" width="3" height="12" fill="#FF6B35"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-value" data-metric="seo-score">0.00</div>
                    <div class="metric-change positive">
                        <span class="change-arrow">↑</span>
                        <span class="change-text">5% from last month</span>
                    </div>
                </div>

                <!-- Impressions Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Impressions</h3>
                        <div class="metric-icon traffic-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M3 18L9 12L15 18L21 12" stroke="#FF6B35" stroke-width="2" fill="none"/>
                                <path d="M3 12L9 6L15 12L21 6" stroke="#FF6B35" stroke-width="2" fill="none"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-value" data-metric="organic-traffic">0</div>
                    <div class="metric-change positive">
                        <span class="change-arrow">↑</span>
                        <span class="change-text">12% from last month</span>
                    </div>
                </div>

                <!-- CTR Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">CTR</h3>
                        <div class="metric-icon backlinks-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="#FF6B35" stroke-width="2"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="#FF6B35" stroke-width="2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-value" data-metric="ctr">0.00%</div>
                    <div class="metric-change positive">
                        <span class="change-arrow">↑</span>
                        <span class="change-text">0.5% from last month</span>
                    </div>
                </div>

                <!-- Average Position Card -->
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Avg Position</h3>
                        <div class="metric-icon keyword-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <circle cx="11" cy="11" r="8" stroke="#FF6B35" stroke-width="2"/>
                                <path d="M21 21L16.65 16.65" stroke="#FF6B35" stroke-width="2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-value" data-metric="avg-position">0.0</div>
                    <div class="metric-change positive">
                        <span class="change-arrow">↑</span>
                        <span class="change-text">1.6 positions</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <h2 class="chat-title">Solvia</h2>
                <p class="chat-description">I oversee your entire SEO team. Ask me anything about your SEO performance.</p>
            </div>
            
            <div class="chat-messages">
                <div class="message ai-message">
                    <div class="message-content">
                        <div class="message-sender">Solvia</div>
                        <div class="message-text">Hello! I'm Solvia, your SEO agent. How can I help you today?</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-section">
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type a message ...">
                    <button id="sendButton" class="send-button">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <div class="quick-replies">
                    <button class="quick-reply-btn">How was my SEO last week?</button>
                    <button class="quick-reply-btn">Any pressing issues this month?</button>
                    <button class="quick-reply-btn">What can you do?</button>
                    <button class="quick-reply-btn">Suggest keywords for my blog</button>
                </div>
            </div>
        </div>

        <!-- AI Agents Section -->
        <div class="ai-agents-section">
            <h2 class="ai-agents-title">Meet Your AI Agents</h2>
            
            <div class="agents-grid">
                <!-- Kenji - Keyword Agent -->
                <div class="agent-card">
                    <div class="agent-header">
                        <div class="agent-icon kenji-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <circle cx="11" cy="11" r="8" stroke="white" stroke-width="2"/>
                                <path d="M21 21L16.65 16.65" stroke="white" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="agent-info">
                            <h3 class="agent-name">Kenji</h3>
                            <p class="agent-type">Keyword Agent</p>
                        </div>
                    </div>
                    <div class="agent-description">
                        I'll find untapped keyword opportunities and help you rank higher. I analyze search trends and competitive gaps.
                    </div>
                    <div class="agent-status">Last run: Just now.</div>
                    <button class="agent-btn kenji-btn" disabled>Coming soon</button>
                </div>

                <!-- Myer - Metadata Agent -->
                <div class="agent-card">
                    <div class="agent-header">
                        <div class="agent-icon myer-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="white" stroke-width="2"/>
                                <polyline points="14,2 14,8 20,8" stroke="white" stroke-width="2"/>
                                <line x1="16" y1="13" x2="8" y2="13" stroke="white" stroke-width="2"/>
                                <line x1="16" y1="17" x2="8" y2="17" stroke="white" stroke-width="2"/>
                                <polyline points="10,9 9,9 8,9" stroke="white" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="agent-info">
                            <h3 class="agent-name">Myer</h3>
                            <p class="agent-type">Metadata Agent</p>
                        </div>
                    </div>
                    <div class="agent-description">
                        I craft compelling titles & descriptions that boost click-through rates while maintaining SEO best practices.
                    </div>
                    <div class="agent-status">Last run: 19 hours ago.</div>
                    <button class="agent-btn myer-btn" disabled>Coming soon</button>
                </div>
            </div>
        </div>

    </div>

    <script src="/static/js/sidemenu.js"></script>
    <script>
        // Get user info from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');
        
        if (!accessToken) {
            window.location.href = '/ui';
        }



        // Fetch user data
        async function fetchUserData() {
            try {
                const response = await fetch('/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    // Update user name if available
                    if (userData.name) {
                        document.querySelector('.user-name').textContent = userData.name;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }

        // Fetch selected website
        async function fetchSelectedWebsite() {
            try {
                const response = await fetch('/auth/gsc/selected-website', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.selected_website) {
                        document.querySelector('.domain').textContent = data.selected_website;
                        // Fetch GSC metrics after getting the website
                        await fetchGSCMetrics();
                    } else {
                        document.querySelector('.domain').textContent = 'No website selected';
                    }
                }
            } catch (error) {
                console.error('Error fetching selected website:', error);
                document.querySelector('.domain').textContent = 'Error loading website';
            }
        }

        // Fetch GSC metrics
        async function fetchGSCMetrics() {
            try {
                console.log('Fetching GSC metrics...');
                const response = await fetch('/auth/gsc/metrics', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('GSC metrics response:', data);
                    
                    if (data.success && data.metrics) {
                        console.log('Updating metrics with:', data.metrics);
                        updateMetrics(data.metrics);
                    } else {
                        console.log('No metrics available:', data.message);
                    }
                } else {
                    console.error('Failed to fetch GSC metrics:', response.status);
                }
            } catch (error) {
                console.error('Error fetching GSC metrics:', error);
            }
        }

        // Update metrics on dashboard
        function updateMetrics(metrics) {
            // Update SEO Score
            const seoScoreElement = document.querySelector('.metric-value[data-metric="seo-score"]');
            if (seoScoreElement) {
                seoScoreElement.textContent = metrics.seo_score;
            }
            
            // Update Impressions (formerly Organic Traffic)
            const impressionsElement = document.querySelector('.metric-value[data-metric="organic-traffic"]');
            if (impressionsElement) {
                impressionsElement.textContent = metrics.organic_traffic.toLocaleString();
            }
            
            // Update CTR
            const ctrElement = document.querySelector('.metric-value[data-metric="ctr"]');
            if (ctrElement && metrics.ctr !== undefined) {
                ctrElement.textContent = metrics.ctr.toFixed(2) + '%';
            }
            
            // Update Average Position
            const avgPositionElement = document.querySelector('.metric-value[data-metric="avg-position"]');
            if (avgPositionElement) {
                avgPositionElement.textContent = metrics.avg_position;
            }
        }



        // Load user data on page load
        fetchUserData();
        fetchSelectedWebsite();

        // Chat Functionality
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.querySelector('.chat-messages');
        const quickReplyButtons = document.querySelectorAll('.quick-reply-btn');

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = 'Solvia';
            contentDiv.appendChild(senderDiv);
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = 'Thinking...';
            contentDiv.appendChild(textDiv);
            
            typingDiv.appendChild(contentDiv);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Send button click
        sendButton.addEventListener('click', () => {
            sendMessage(chatInput.value);
        });

        // Enter key press
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(chatInput.value);
            }
        });

        // Quick reply button clicks
        quickReplyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const message = button.textContent;
                sendMessage(message);
            });
        });

        // Focus input on page load
        chatInput.focus();

        // Agents Dropdown Functionality
        function toggleAgentsDropdown() {
            const agentsItem = document.querySelector('.agents-item');
            const dropdown = document.getElementById('agentsDropdown');
            
            agentsItem.classList.toggle('expanded');
            dropdown.classList.toggle('show');
        }

        // Chat Functionality
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessageToChat(message, 'user', 'You');
            chatInput.value = '';

            // Show thinking indicator
            showTypingIndicator();

            try {
                const response = await fetch('/auth/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        message_content: message,
                        message_type: 'user',
                        sender_name: 'You'
                    })
                });

                // Hide thinking indicator
                hideTypingIndicator();

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Handle multiple AI responses with delays
                        if (data.ai_responses && data.ai_responses.length > 1) {
                            // Add each response with a 1-second delay
                            for (let i = 0; i < data.ai_responses.length; i++) {
                                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
                                addMessageToChat(data.ai_responses[i], 'ai', 'Solvia');
                            }
                        } else {
                            // Single response (backward compatibility)
                            addMessageToChat(data.ai_response, 'ai', 'Solvia');
                        }
                    }
                } else {
                    console.error('Failed to send message');
                    addMessageToChat('Sorry, I encountered an error. Please try again.', 'ai', 'Solvia');
                }
            } catch (error) {
                // Hide thinking indicator
                hideTypingIndicator();
                console.error('Error sending message:', error);
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'ai', 'Solvia');
            }
        }

        function addMessageToChat(content, type, sender, isHistorical = false) {
            const messagesContainer = document.querySelector('.chat-messages');
            
            // For AI messages, detect paragraphs and split into separate bubbles
            if (type === 'ai') {
                // First, convert HTML paragraph separators to plain text line breaks
                // But preserve bullet points and other formatting
                let processedContent = content
                    .replace(/<\/p>\s*<p[^>]*>/gi, '\n\n')  // Convert </p><p> to double line breaks
                    .replace(/<br\s*\/?>\s*<br\s*\/?>/gi, '\n\n')  // Convert <br><br> to double line breaks
                    .replace(/<br\s*\/?>/gi, '\n')  // Convert single <br> to single line break
                    .replace(/<\/p>/gi, '\n\n')  // Convert </p> to double line breaks
                    .replace(/<p[^>]*>/gi, '')  // Remove opening <p> tags
                    // Keep bullet points and other formatting - only remove basic HTML tags
                    .replace(/<(?!\/?(?:ul|ol|li|strong|em|b|i|u|code|pre|blockquote|h[1-6]))[^>]*>/g, '')
                    .trim();
                
                // Split by double line breaks (paragraphs)
                const paragraphs = processedContent.split(/\n\s*\n/).filter(p => p.trim());
                
                if (paragraphs.length > 1 && !isHistorical) {
                    // Multiple paragraphs - create separate bubbles with delays (only for new messages)
                    paragraphs.forEach((paragraph, index) => {
                        setTimeout(() => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${type}-message`;
                            
                            // Render HTML content for AI messages
                            const contentToDisplay = paragraph.trim();
                            
                            messageDiv.innerHTML = `
                                <div class="message-content">
                                    <div class="message-sender">${sender}</div>
                                    <div class="message-text">${contentToDisplay}</div>
                                </div>
                            `;
                            
                            messagesContainer.appendChild(messageDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, index * 1000); // 1 second delay for each paragraph
                    });
                } else {
                    // Single paragraph or historical message - create one bubble immediately
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}-message`;
                    
                    const contentToDisplay = content.trim();
                    
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-sender">${sender}</div>
                            <div class="message-text">${contentToDisplay}</div>
                        </div>
                    `;
                    
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } else {
                // User message - single bubble
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                
                // Escape HTML for user messages
                const contentToDisplay = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-sender">${sender}</div>
                        <div class="message-text">${contentToDisplay}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Load chat history on page load
        async function loadChatHistory() {
            try {
                console.log('Loading chat history...');
                const response = await fetch('/auth/chat/history', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Chat history response:', data);
                    
                    if (data.success && data.messages.length > 0) {
                        console.log(`Found ${data.messages.length} historical messages`);
                        // Clear existing messages
                        const messagesContainer = document.querySelector('.chat-messages');
                        messagesContainer.innerHTML = '';
                        
                        // Add historical messages
                        data.messages.forEach(msg => {
                            const sender = msg.sender_name || (msg.message_type === 'ai' ? 'Solvia' : 'You');
                            addMessageToChat(msg.message_content, msg.message_type, sender, true);
                        });
                    } else {
                        console.log('No historical messages found');
                    }
                } else {
                    console.error('Failed to load chat history:', response.status);
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Quick reply functionality
        document.querySelectorAll('.quick-reply-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const message = this.textContent;
                chatInput.value = message;
                sendMessage();
            });
        });



        // Initialize sidemenu and load data when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initSideMenu('dashboard');
            loadChatHistory();
        });

        // Add click event to settings menu item
        document.querySelector('.menu-bottom .menu-item:nth-child(2)').addEventListener('click', function() {
            window.location.href = `/settings?access_token=${accessToken}`;
        });

        // Add logout functionality to sidemenu
        document.querySelector('.menu-bottom .menu-item:last-child').addEventListener('click', async function() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                window.location.href = '/ui';
            } catch (error) {
                console.error('Error logging out:', error);
                window.location.href = '/ui';
            }
        });
    </script>
</body>
</html> 