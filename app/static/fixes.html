<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Fixes - Solvia Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=1.2">
    <style>
        /* Additional styles for the Fixes page */
        .page-description {
            color: #6b7280;
            margin-top: 0.5rem;
            font-size: 1rem;
        }

        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            color: #9ca3af;
            margin-bottom: 1.5rem;
        }

        .business-model-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .recommendation-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
        }

        .recommendation-item.quick-win {
            border-color: #fbbf24;
            background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%);
        }

        .recommendation-header {
            margin-bottom: 1rem;
        }

        .recommendation-title-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .recommendation-rank {
            background: #374151;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 2rem;
            text-align: center;
        }

        .recommendation-title {
            flex: 1;
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }

        .priority-score {
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .priority-high {
            background: #dc2626;
            color: white;
        }

        .priority-medium {
            background: #f59e0b;
            color: white;
        }

        .priority-low {
            background: #6b7280;
            color: white;
        }

        .recommendation-meta {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .timeline-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .timeline-urgent {
            background: #fee2e2;
            color: #dc2626;
        }

        .timeline-short {
            background: #fef3c7;
            color: #d97706;
        }

        .timeline-medium {
            background: #e0f2fe;
            color: #0369a1;
        }

        .category-badge {
            background: #f3f4f6;
            color: #374151;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .recommendation-description {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .recommendation-scoring {
            margin-bottom: 1.5rem;
        }

        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .score-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .score-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .score-bar {
            position: relative;
            background: #f3f4f6;
            height: 1.5rem;
            border-radius: 0.75rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #3b82f6;
            transition: width 0.5s ease;
        }

        .score-bar.effort .score-fill {
            background: #ef4444;
        }

        .score-value {
            position: relative;
            z-index: 1;
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
        }

        .implementation-steps {
            margin-bottom: 1rem;
        }

        .implementation-steps h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .implementation-steps ol {
            margin: 0;
            padding-left: 1.5rem;
        }

        .implementation-steps li {
            margin-bottom: 0.5rem;
            color: #4b5563;
            line-height: 1.5;
        }

        .business-context {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
            font-size: 0.875rem;
            color: #374151;
        }

        .quick-wins-icon {
            color: #f59e0b;
        }

        .recommendations-stats {
            background: #f3f4f6;
            color: #374151;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .action-plan-stats {
            padding: 1rem 0;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .top-priority-highlight {
            background: linear-gradient(135deg, #dbeafe 0%, #f0f9ff 100%);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #93c5fd;
        }

        .top-priority-highlight h4 {
            margin: 0 0 0.5rem 0;
            color: #1e40af;
        }

        .btn-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @media (max-width: 768px) {
            .recommendation-title-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .scoring-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
    </style>
</head>
<body class="dashboard-body">
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/dashboard" style="text-decoration: none; color: inherit;">Solvia</a>
        </div>
        <div class="navbar-user">
            <div class="user-avatar" id="userAvatar" onclick="toggleMobileMenu()">S</div>
            <span id="userEmail" class="desktop-only">user@example.com</span>
            <button class="logout-btn desktop-only" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- Mobile Side Menu -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
    <div id="mobileMenu" class="mobile-menu">
        <div class="mobile-menu-header">
            <div class="mobile-menu-avatar" id="mobileMenuAvatar">S</div>
            <div class="mobile-menu-user-info">
                <div class="mobile-menu-email" id="mobileMenuEmail">user@example.com</div>
                <div class="mobile-menu-website" id="mobileMenuWebsite">No website selected</div>
            </div>
            <button class="mobile-menu-close" onclick="closeMobileMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="mobile-menu-content">
            <div class="mobile-menu-section">
                <div class="mobile-menu-section-title">Navigation</div>
                <button class="mobile-menu-item" onclick="window.location.href='/dashboard'; closeMobileMenu();">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Dashboard</span>
                </button>
                <button class="mobile-menu-item active" onclick="closeMobileMenu();">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span>SEO Fixes</span>
                </button>
            </div>
            <div class="mobile-menu-section">
                <div class="mobile-menu-section-title">Website</div>
                <button class="mobile-menu-item" onclick="changeWebsite(); closeMobileMenu();">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    <span>Change Website</span>
                </button>
            </div>
            <div class="mobile-menu-section">
                <div class="mobile-menu-section-title">Account</div>
                <button class="mobile-menu-item" onclick="logout()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16,17 21,12 16,7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>SEO Fixes</h1>
                <p class="page-description">Prioritized action plan to improve your SEO performance</p>
                <div id="websiteInfo" class="website-info">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        Website: 
                    </span>
                    <span id="trackedWebsite" class="tracked-website">Loading...</span>
                </div>
            </div>
            <button onclick="generateReport()" class="btn-primary" id="generateBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
                Generate Report
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state hidden">
            <div class="loading-spinner"></div>
            <h3>Analyzing your website...</h3>
            <p>This may take a few moments while we generate your personalized SEO recommendations.</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
            </div>
            <h2>Ready to optimize your SEO?</h2>
            <p>Click "Generate Report" to get your personalized SEO action plan with prioritized recommendations.</p>
        </div>

        <!-- Results Content -->
        <div id="resultsContent" class="results-content hidden">
            <!-- Action Plan Summary - Moved to top -->
            <div id="actionPlanSection" class="action-plan-overview">
                <div class="action-plan-stats" id="actionPlanStats"></div>
            </div>

            <!-- Executive Summary -->
            <div class="content-card">
                <div class="card-header">
                    <h2>Executive Summary</h2>
                    <div class="business-model-badge" id="businessModelBadge">Unknown</div>
                </div>
                <div class="card-body">
                    <p id="executiveSummary">Loading summary...</p>
                </div>
            </div>

            <!-- Quick Wins Section -->
            <div id="quickWinsSection" class="content-card hidden">
                <div class="card-header">
                    <div class="header-icon quick-wins-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"></polygon>
                        </svg>
                    </div>
                    <h2>⚡ Quick Wins</h2>
                    <div class="status-indicator success">High Impact, Low Effort</div>
                </div>
                <div class="card-body">
                    <div id="quickWinsList"></div>
                </div>
            </div>

            <!-- Priority Recommendations -->
            <div class="content-card">
                <div class="card-header">
                    <div class="header-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <h2>Prioritized Recommendations</h2>
                    <div class="recommendations-stats" id="recommendationsStats">0 recommendations</div>
                </div>
                <div class="card-body">
                    <div id="recommendationsList"></div>
                </div>
            </div>


        </div>
    </div>

    <script>
        // Global variables
        let currentAnalysis = null;
        let userEmail = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            // Check authentication first
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/ui';
                return;
            }

            try {
                // Get user info
                const userResponse = await apiCall('/auth/me');
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    userEmail = userData.email;
                    updateUserInterface(userData);
                } else {
                    console.error('Failed to get user data, but allowing page to load');
                    // Set default user display
                    document.getElementById('userEmail').textContent = 'User';
                    document.getElementById('userAvatar').textContent = 'U';
                    document.getElementById('mobileMenuEmail').textContent = 'User';
                    document.getElementById('mobileMenuAvatar').textContent = 'U';
                }
            } catch (error) {
                console.error('Error getting user data:', error);
                // Continue loading page with default user display
            }

            try {
                // Get user's website
                await loadUserWebsite();
            } catch (error) {
                console.error('Error loading website:', error);
                // Continue loading page
            }

            try {
                // Check for stored report data from dashboard
                await checkForStoredReport();
            } catch (error) {
                console.error('Error checking stored report:', error);
                // Continue loading page - just show empty state
            }
        }

        async function checkForStoredReport() {
            try {
                // First, check for localStorage data (from dashboard redirect)
                const storedData = localStorage.getItem('seo_report_data');
                const storedTimestamp = localStorage.getItem('seo_report_timestamp');
                
                if (storedData && storedTimestamp) {
                    const timestamp = parseInt(storedTimestamp);
                    const now = Date.now();
                    const fiveMinutes = 5 * 60 * 1000; // 5 minutes in milliseconds
                    
                    // Check if the stored data is less than 5 minutes old
                    if (now - timestamp < fiveMinutes) {
                        console.log('[DEBUG] Found fresh stored report data, displaying...');
                        const reportData = JSON.parse(storedData);
                        currentAnalysis = reportData;
                        
                        // Display the stored report
                        displayAnalysisResults(reportData);
                        
                        // Hide empty state, show results
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('resultsContent').classList.remove('hidden');
                        
                        // Clear the stored data so it doesn't show again on refresh
                        localStorage.removeItem('seo_report_data');
                        localStorage.removeItem('seo_report_timestamp');
                        
                        return;
                    } else {
                        console.log('[DEBUG] Stored report data is too old, clearing...');
                        // Clear old data
                        localStorage.removeItem('seo_report_data');
                        localStorage.removeItem('seo_report_timestamp');
                    }
                }
                
                // If no localStorage data, check for existing reports in database
                console.log('[DEBUG] No fresh localStorage data, checking for existing reports...');
                await checkForExistingReport();
                
            } catch (error) {
                console.error('Error checking stored report:', error);
                // Clear corrupted data
                localStorage.removeItem('seo_report_data');
                localStorage.removeItem('seo_report_timestamp');
            }
        }

        async function checkForExistingReport() {
            try {
                console.log('[DEBUG] Checking for existing reports in database...');
                const response = await apiCall('/api/reports/latest');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.has_report && data.report) {
                        console.log('[DEBUG] Found existing report, displaying...');
                        currentAnalysis = data.report;
                        
                        // Display the existing report
                        displayAnalysisResults(data.report);
                        
                        // Hide empty state, show results
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('resultsContent').classList.remove('hidden');
                        
                        // Hide the generate button completely - no replacement button
                        const generateBtn = document.getElementById('generateBtn');
                        if (generateBtn) {
                            generateBtn.style.display = 'none';
                            console.log('[DEBUG] Generate button hidden - existing report loaded');
                        }
                        
                        // Also hide the parent container if it exists
                        const generateContainer = generateBtn.closest('.generate-section');
                        if (generateContainer) {
                            generateContainer.style.display = 'none';
                            console.log('[DEBUG] Generate container hidden');
                        }
                        
                        // Update page title to show report is loaded
                        document.title = 'SEO Report - Solvia';
                        
                        return true;
                    } else {
                        console.log('[DEBUG] No existing reports found');
                        return false;
                    }
                } else {
                    console.log('[DEBUG] Failed to check for existing reports, status:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Error checking for existing reports:', error);
                return false;
            }
        }





        async function loadUserWebsite() {
            try {
                const response = await apiCall('/auth/website');
                if (response.ok) {
                    const data = await response.json();
                    if (data.website_url) {
                        document.getElementById('trackedWebsite').textContent = data.website_url;
                    } else {
                        document.getElementById('trackedWebsite').textContent = 'No website configured';
                        // Optionally disable generate button
                        const generateBtn = document.getElementById('generateBtn');
                        if (generateBtn) {
                            generateBtn.disabled = true;
                            generateBtn.innerHTML = '<span>Add Website First</span>';
                        }
                    }
                } else {
                    console.error('Failed to load website, status:', response.status);
                    document.getElementById('trackedWebsite').textContent = 'Website not configured';
                }
            } catch (error) {
                console.error('Error loading website:', error);
                document.getElementById('trackedWebsite').textContent = 'Website not configured';
            }
        }

        function updateUserInterface(userData) {
            const userEmail = userData.email;
            const userInitial = userEmail.charAt(0).toUpperCase();
            
            // Update user display elements
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('userAvatar').textContent = userInitial;
            document.getElementById('mobileMenuEmail').textContent = userEmail;
            document.getElementById('mobileMenuAvatar').textContent = userInitial;
        }

        async function generateReport() {
            const generateBtn = document.getElementById('generateBtn');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const resultsContent = document.getElementById('resultsContent');

            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="btn-spinner"></div> Generating...';
                loadingState.classList.remove('hidden');
                emptyState.classList.add('hidden');
                resultsContent.classList.add('hidden');

                // Call API to generate report
                const response = await apiCall('/api/generate-report', {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate report');
                }

                const data = await response.json();
                currentAnalysis = data;

                // Display results
                displayAnalysisResults(data);

                // Hide loading, show results
                loadingState.classList.add('hidden');
                resultsContent.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate report: ' + error.message);
                
                // Reset states
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } finally {
                // Reset button
                generateBtn.disabled = false;
                generateBtn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    Generate Report
                `;
            }
        }

        function displayAnalysisResults(data) {
            const analysis = data.analysis;
            
            // Update website info
            document.getElementById('trackedWebsite').textContent = data.website_url;
            
            // Business model badge
            document.getElementById('businessModelBadge').textContent = data.business_model;
            
            // Executive summary with data source info
            let summaryText = analysis.executive_summary;
            if (data.metrics_used) {
                const dataSources = [];
                if (data.metrics_used.gsc_data_available) dataSources.push("Google Search Console");
                if (data.metrics_used.psi_data_available) dataSources.push("PageSpeed Insights");
                
                if (dataSources.length > 0) {
                    summaryText += `\n\nThis analysis is based on real data from: ${dataSources.join(", ")}.`;
                } else {
                    summaryText += "\n\nThis analysis uses baseline metrics. Connect Google Search Console for more accurate recommendations.";
                }
            }
            document.getElementById('executiveSummary').textContent = summaryText;
            
            // Quick wins
            if (analysis.quick_wins && analysis.quick_wins.length > 0) {
                displayQuickWins(analysis.quick_wins);
                document.getElementById('quickWinsSection').classList.remove('hidden');
            } else {
                document.getElementById('quickWinsSection').classList.add('hidden');
            }
            
            // Prioritized recommendations
            if (analysis.prioritized_recommendations) {
                displayRecommendations(analysis.prioritized_recommendations);
                document.getElementById('recommendationsStats').textContent = 
                    `${analysis.prioritized_recommendations.length} recommendations`;
            }
            
            // Action plan summary
            if (analysis.action_plan_summary) {
                displayActionPlanSummary(analysis.action_plan_summary);
            }
        }

        function displayQuickWins(quickWins) {
            const container = document.getElementById('quickWinsList');
            container.innerHTML = '';
            
            quickWins.forEach(rec => {
                const quickWinElement = createRecommendationElement(rec, true);
                container.appendChild(quickWinElement);
            });
        }

        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');
            container.innerHTML = '';
            
            recommendations.forEach((rec, index) => {
                const recElement = createRecommendationElement(rec, false, index + 1);
                container.appendChild(recElement);
            });
        }

        function createRecommendationElement(rec, isQuickWin = false, rank = null) {
            const div = document.createElement('div');
            div.className = `recommendation-item ${isQuickWin ? 'quick-win' : ''}`;
            
            const priorityClass = getPriorityClass(rec.priority_score);
            const timelineColor = getTimelineColor(rec.timeline);
            
            div.innerHTML = `
                <div class="recommendation-header">
                    <div class="recommendation-title-row">
                        ${rank ? `<span class="recommendation-rank">#${rank}</span>` : ''}
                        <h3 class="recommendation-title">${rec.title}</h3>
                        <div class="priority-score ${priorityClass}">${rec.priority_score}</div>
                    </div>
                    <div class="recommendation-meta">
                        <span class="timeline-badge ${timelineColor}">${rec.timeline}</span>
                        <span class="category-badge">${rec.subcategory || rec.category}</span>
                    </div>
                </div>
                <div class="recommendation-body">
                    <p class="recommendation-description">${rec.description}</p>
                    <div class="recommendation-scoring">
                        <div class="scoring-grid">
                            <div class="score-item">
                                <span class="score-label">Business Impact</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${rec.business_impact * 10}%"></div>
                                    <span class="score-value">${rec.business_impact}/10</span>
                                </div>
                            </div>
                            <div class="score-item">
                                <span class="score-label">SEO Impact</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${rec.seo_impact * 10}%"></div>
                                    <span class="score-value">${rec.seo_impact}/10</span>
                                </div>
                            </div>
                            <div class="score-item">
                                <span class="score-label">Urgency</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${rec.urgency * 10}%"></div>
                                    <span class="score-value">${rec.urgency}/10</span>
                                </div>
                            </div>
                            <div class="score-item">
                                <span class="score-label">Effort</span>
                                <div class="score-bar effort">
                                    <div class="score-fill" style="width: ${rec.implementation_effort * 10}%"></div>
                                    <span class="score-value">${rec.implementation_effort}/10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="implementation-steps">
                        <h4>Implementation Steps:</h4>
                        <ol>
                            ${rec.implementation_steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    ${rec.business_context_adjustment ? `
                        <div class="business-context">
                            <strong>Business Context:</strong> ${rec.business_context_adjustment}
                        </div>
                    ` : ''}
                </div>
            `;
            
            return div;
        }

        function displayActionPlanSummary(actionPlan) {
            const container = document.getElementById('actionPlanStats');
            
            container.innerHTML = `
                <div class="metric-box">
                    <div class="metric-value">${actionPlan.total_recommendations}</div>
                    <div class="metric-label">Total Recommendations</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${actionPlan.quick_wins}</div>
                    <div class="metric-label">Quick Wins</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value">${actionPlan.average_priority_score}</div>
                    <div class="metric-label">Avg Priority Score</div>
                </div>
                ${actionPlan.top_priority_recommendation ? `
                    <div class="metric-box top-priority">
                        <div class="metric-value">#1</div>
                        <div class="metric-label">Top Priority</div>
                        <div class="metric-detail">${actionPlan.top_priority_recommendation.title}</div>
                    </div>
                ` : ''}
            `;
        }

        function getPriorityClass(score) {
            if (score >= 8) return 'priority-high';
            if (score >= 6) return 'priority-medium';
            return 'priority-low';
        }

        function getTimelineColor(timeline) {
            if (timeline.includes('days')) return 'timeline-urgent';
            if (timeline.includes('week')) return 'timeline-short';
            return 'timeline-medium';
        }

        // Utility functions
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('auth_token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            return fetch(endpoint, { ...defaultOptions, ...options });
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            mobileMenu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('mobileMenuOverlay');
            mobileMenu.classList.remove('active');
            overlay.classList.remove('active');
        }

        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/ui';
        }

        function changeWebsite() {
            window.location.href = '/setup';
        }
    </script>
</body>
</html> 